<!DOCTYPE html>
<html>
<head>
	<title>Export Array Tool</title>
	<meta charset="utf-8" />
	<script type="text/javascript" src="./common.js"></script>
	<script type="text/javascript">
	window.addEventListener("load", create, false);

	var list = [], blockList = [], historyList = [];

	function create () {
		var drawDivTag = document.getElementById("draw_div");

		var col = Math.floor(stageW / particleW),
			row = Math.floor(stageH / particleH);

		for (var i = 0; i < row; i++) {
			var rowList = [];
			var blockRowList = [];

			for (var j = 0; j < col; j++) {
				rowList.push(false);

				var blockObj = document.createElement("div");
				blockObj.style.width = particleW + "px";
				blockObj.style.height = particleH + "px";
				blockObj.style.border = "1px black solid";
				blockObj.style.position = "absolute";
				blockObj.style.left = j * particleW + "px";
				blockObj.style.top = i * particleH + "px";
				blockObj.style.backgroundColor = "#FFFFFF";
				blockObj.positionInList = {x : j, y : i};
				drawDivTag.appendChild(blockObj);

				blockObj.addEventListener("mouseup", onMouseUp, false);

				blockRowList.push(blockObj);
			}

			list.push(rowList);
			blockList.push(blockRowList);
		}

		var bd = document.getElementById("ctrl_div");
		bd.style.marginTop = stageH + 20 + "px";

		document.getElementById("result").innerHTML = "";
	}

	function onMouseUp (e) {
		var o = e.target,
			x = o.positionInList.x,
			y = o.positionInList.y;

		pushHistory();

		if (list[y] != null && list[y][x] != null) {
			var v = !list[y][x];

			list[y][x] = v;

			o.style.backgroundColor = v ? "#666666" : "#FFFFFF";
		}
	}

	function undo() {
		if (historyList.length <= 0) {
			return;
		}

		updateArray(historyList.pop());
	}

	function pushHistory() {
		if (historyList.length > 10) {
			historyList.shift();
		}
		historyList.push(copyList(list));
	}

	function copyList() {
		var newLs = [];

		for (var i = 0, l = list.length; i < l; i++) {
			var row = [];

			for (var j = 0, n = list[i].length; j < n; j++) {
				row.push(list[i][j]);
			}

			newLs.push(row);
		}

		return newLs;
	}

	function importArray() {
		var importContent = document.getElementById("import_content").value;

		try {
			pushHistory();

			var importArr = eval(importContent);
			updateArray(importArr);
		} catch(e) {
			alert("Invalid import content.");
		}
	}

	function updateArray(ls) {
		for (var i = 0, l = ls.length; i < l; i++) {
			for (var j = 0, n = ls[i].length; j < n; j++) {
				var v = ls[i][j];

				list[i][j] = v;
				blockList[i][j].style.backgroundColor = v ? "#666666" : "#FFFFFF";
			}
		}
	}

	function exportArray () {
		var content = "[";
		var rd = document.getElementById("result"),
			isRevert = document.getElementById("revert_checkbox").checked;
		
		for (var i  = 0, l = list.length; i < l; i++) {
			var v = list[i].concat();

			if (isRevert) {
				for (var j = 0, n = v.length; j < n; j++) {
					v[j] = !v[j];
				}
			}

			content += "[" + v.toString() + "]";

			if (i != l - 1) {
				content += ",";
			}
		}

		content += "]";

		rd.value = content;
	}
	</script>
</head>
<body>
	<div id="draw_div"></div>
	<div id="ctrl_div">
		<input id="revert_checkbox" type="checkbox" /><span style="padding-right: 10px;">Revert</span>
		<button onclick="create()">Reset</button>
		<button onclick="undo()">Undo</button>
		<button onclick="exportArray()">Export Array</button>
		<button onclick="importArray()">Import Array</button>

		<div style="margin-top: 30px;">
			<div style="display: table-cell;">
				<b>Import Content</b><br />
				<textarea spellcheck="false" rows="10" cols="50" id="import_content"></textarea>
			</div>
			<div style="display: table-cell; padding-left: 20px">
				<b>Result</b><br />
				<textarea spellcheck="false" rows="10" cols="50" id="result"></textarea>
			</div>
		</div>
	</div>
</body>
</html>